local u=game:GetService("UserInputService")
local r=game:GetService("RunService")
local sg=Instance.new("ScreenGui",game:GetService("CoreGui"))
sg.IgnoreGuiInset=true
sg.ResetOnSpawn=false
sg.ZIndexBehavior=Enum.ZIndexBehavior.Sibling

local g={}
local windows = {}

local spacing = 10
local width = 300
local yPos = 50

local function dragFrame(frame, dragArea)
    local dragging = false
    local dragInput, dragStart, startPos

    dragArea.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    dragArea.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)

    r.RenderStepped:Connect(function()
        if dragging and dragInput then
            local delta = dragInput.Position - dragStart
            frame.Position = UDim2.new(
                0,
                math.clamp(startPos.X.Offset + delta.X, 0, workspace.CurrentCamera.ViewportSize.X - frame.AbsoluteSize.X),
                0,
                math.clamp(startPos.Y.Offset + delta.Y, 0, workspace.CurrentCamera.ViewportSize.Y - frame.AbsoluteSize.Y)
            )
        end
    end)
end

function g.newWindow(title, index)
    local w=Instance.new("Frame",sg)
    w.BackgroundColor3=Color3.fromRGB(30,30,30)
    w.BorderSizePixel=0
    w.Size=UDim2.new(0,width,0,40)
    w.Position=UDim2.new(0,(width+spacing)*(index-1)+spacing,0,yPos)
    w.ClipsDescendants=true
    w.ZIndex=100

    local header=Instance.new("TextLabel",w)
    header.Text=title
    header.Font=Enum.Font.SourceSansBold
    header.TextSize=22
    header.TextColor3=Color3.new(1,1,1)
    header.BackgroundColor3=Color3.fromRGB(50,50,50)
    header.Size=UDim2.new(1,-40,0,40)
    header.Position=UDim2.new(0,0,0,0)
    header.TextXAlignment=Enum.TextXAlignment.Left
    header.ClipsDescendants=true
    header.Active=true

    local toggleBtn=Instance.new("TextButton",w)
    toggleBtn.Text = "+"
    toggleBtn.Font=Enum.Font.SourceSansBold
    toggleBtn.TextSize=28
    toggleBtn.TextColor3=Color3.new(1,1,1)
    toggleBtn.BackgroundColor3=Color3.fromRGB(70,70,70)
    toggleBtn.Size=UDim2.new(0,40,0,40)
    toggleBtn.Position=UDim2.new(0, w.Size.X.Offset - 40, 0, 0)
    toggleBtn.AutoButtonColor=false

    local content=Instance.new("Frame",w)
    content.BackgroundColor3=Color3.fromRGB(40,40,40)
    content.Size=UDim2.new(1,0,0,0)
    content.Position=UDim2.new(0,0,0,40)
    content.Visible=false

    local layout=Instance.new("UIListLayout",content)
    layout.Padding=UDim.new(0,5)
    layout.SortOrder=Enum.SortOrder.LayoutOrder

    local expanded = false

    local function toggle()
        expanded = not expanded
        if expanded then
            toggleBtn.Text = "â€“"
            content.Visible=true
            content.Size=UDim2.new(1,0,0,layout.AbsoluteContentSize.Y)
            w.Size=UDim2.new(0,width,0,40 + layout.AbsoluteContentSize.Y)
        else
            toggleBtn.Text = "+"
            content.Visible=false
            content.Size=UDim2.new(1,0,0,0)
            w.Size=UDim2.new(0,width,0,40)
        end
    end

    toggleBtn.MouseButton1Click:Connect(toggle)
    
    -- Optional: toggle on header double-click
    local lastClick=0
    header.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            local now=tick()
            if now - lastClick < 0.3 then
                toggle()
            end
            lastClick=now
        end
    end)

    r.Heartbeat:Connect(function()
        if expanded then
            content.Size=UDim2.new(1,0,0,layout.AbsoluteContentSize.Y)
            w.Size=UDim2.new(0,width,0,40 + layout.AbsoluteContentSize.Y)
        end
    end)

    dragFrame(w, header)

    local api = {}

    function api.addButton(text, callback)
        local btn = Instance.new("TextButton", content)
        btn.Text = text
        btn.Size = UDim2.new(1, -10, 0, 30)
        btn.Position = UDim2.new(0, 5, 0, 0)
        btn.BackgroundColor3 = Color3.fromRGB(60,60,60)
        btn.TextColor3 = Color3.new(1,1,1)
        btn.Font = Enum.Font.SourceSans
        btn.TextSize = 18
        btn.AutoButtonColor = false
        btn.MouseButton1Click:Connect(callback)
        return btn
    end

    function api.addToggle(text, callback)
        local state = false
        local btn = Instance.new("TextButton", content)
        btn.Text = text .. ": OFF"
        btn.Size = UDim2.new(1, -10, 0, 30)
        btn.Position = UDim2.new(0, 5, 0, 0)
        btn.BackgroundColor3 = Color3.fromRGB(60,60,60)
        btn.TextColor3 = Color3.new(1,1,1)
        btn.Font = Enum.Font.SourceSans
        btn.TextSize = 18
        btn.AutoButtonColor = false
        btn.MouseButton1Click:Connect(function()
            state = not state
            btn.Text = text .. (state and ": ON" or ": OFF")
            callback(state)
        end)
        return btn
    end

    api._frame = w
    windows[#windows+1] = w

    return api
end

return g
